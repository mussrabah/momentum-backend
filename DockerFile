# Stage 1: Build the application
# We use a base image with JDK 17. The Gradle Wrapper will handle downloading Gradle 8.14.3.
FROM eclipse-temurin:17-jdk-alpine AS builder
WORKDIR /app

# Copy necessary Gradle files first to cache dependencies
COPY gradle gradle
COPY gradlew .
COPY build.gradle.kts .
COPY settings.gradle.kts .
COPY gradle.properties .
# Note: libs.versions.toml is usually in 'gradle/libs.versions.toml', handled by 'COPY gradle gradle'

# Grant execution rights to the wrapper
RUN chmod +x ./gradlew

# Download dependencies (this step is cached if dependencies don't change)
# We run 'build' with --no-daemon to ensure it exits cleanly
RUN ./gradlew dependencies --no-daemon

# Copy the actual source code
COPY src src

# Build the application (skipping tests for the build stage to speed it up,
# assuming tests run in CI)
RUN ./gradlew bootJar --no-daemon -x test

# Stage 2: Run the application
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Copy the built jar from the builder stage
# The jar is usually located in build/libs/
COPY --from=builder /app/build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]